# OBS Lua 現在時刻表示スクリプト ドキュメント

このLuaスクリプトは、OBS Studioのテキストソースを使用して、指定されたタイムゾーンの現在時刻を柔軟な書式で表示します。ローカル時刻、UTC、JST、および任意のIANAタイムゾーンに対応しています。

**主な機能:**

* 指定したテキストソースに現在時刻を表示。
* 現在時刻の表示形式を `os.date` 準拠の書式 + カスタム書式 (`%TZN` など) で自由に設定可能。
* 表示するタイムゾーンをIANAタイムゾーン名 (例: `America/Los_Angeles`, `Asia/Tokyo`, `UTC`) で指定可能。
* OSのローカル時刻 (`%N`)、UTC (`%UTC`)、日本標準時 (`%JST`)、指定タイムゾーン (`%TZ`, `%TZN`) の表示に対応。
* TZ Database (zoneinfo/tzdata) ファイルの自動検索・読み込みによる正確なタイムゾーン/夏時間処理。
* POSIX TZ 文字列によるフォールバック機能。
* Windows環境での `os.date` の制限を考慮したタイムゾーン処理 (`%TZN`)。

## インストール方法

1.  OBS Studioを開きます。
2.  メニューから `ツール` > `スクリプト` を選択します。
3.  `スクリプト` タブの左下にある `+` ボタンをクリックします。
4.  ダウンロードした `.lua` ファイルを選択して追加します。
5.  スクリプトがリストに追加され、右側に設定項目が表示されます。

## 設定項目 (スクリプトUI)

スクリプトを選択すると、以下の設定項目が表示されます。

* **Text Source:** 時刻を表示するOBS内のテキストソース（GDI+ または Freetype 2）を選択します。
* **Time Zone:** 表示したい時刻のIANAタイムゾーン名（例: `America/Los_Angeles`, `Asia/Tokyo`, `UTC`）。リストから選択または直接入力します。
* **Text Format:** テキストソースに最終的に表示する内容のテンプレート。利用可能なプレースホルダ（後述）を組み合わせて記述します。
* **Time Format:** `%N`, `%UTC`, `%JST`, `%TZ`, `%TZN` などで日時を表示する際の書式（後述の「日時 書式」参照）。
* **tzpath:** TZ Database (zoneinfo/tzdata) ファイルが格納されているディレクトリのパス。通常は自動検出されますが、必要に応じて手動で指定できます。リストから候補を選択または直接入力。

## プレースホルダ (`Text Format`で使用)

`Time Format` 設定で指定した書式に従って表示されます。

| プレースホルダ | 説明                                                                       |
| :------------- | :------------------------------------------------------------------------- |
| `%N`           | 現在時刻 (OS依存のローカル時刻)                                            |
| `%UTC`         | 現在時刻 (UTC)                                                             |
| `%JST`         | 現在時刻 (日本標準時 JST, UTC+9)                                           |
| `%TZ`          | 現在時刻 (設定された`Time Zone`の時刻)                                     |
| `%TZN`         | 現在時刻 (設定された`Time Zone`の時刻、`os.date`非依存実装)                |
| `%%`           | `%` 文字自体                                                               |
| `%n`           | 改行                                                                       |
| `%t`           | 水平タブ                                                                   |

## 日時 書式 (`Time Format` 設定で使用。`os.date`準拠 + カスタム)

| 書式   | 説明                                                      | 例 (Asia/Tokyo)                  |
| :----- | :-------------------------------------------------------- | :------------------------------- |
| `%Y`   | 年 (4桁)                                                  | `2025`                           |
| `%m`   | 月 (01-12)                                                | `03`                             |
| `%d`   | 日 (01-31)                                                | `29`                             |
| `%H`   | 時 (24時間形式, 00-23)                                    | `15`                             |
| `%M`   | 分 (00-59)                                                | `23`                             |
| `%S`   | 秒 (00-59)                                                | `43`                             |
| `%a`   | 曜日 (省略形)                                             | `Sat`                            |
| `%A`   | 曜日 (完全形)                                             | `Saturday`                       |
| `%b`   | 月 (省略形)                                               | `Mar`                            |
| `%B`   | 月 (完全形)                                               | `March`                          |
| `%z`   | タイムゾーンオフセット (+HHMM または -HHMM形式)             | `+0900`                          |
| `%Z`   | タイムゾーン略称 (例: `PST`, `JST`, `UTC`) ※`%TZN`専用実装 | `JST`                            |
| `%c`   | ロケール依存の日時表現                                    | `Sat Mar 29 15:23:43 2025`       |
| `%x`   | ロケール依存の日付表現                                    | `03/29/25`                       |
| `%X`   | ロケール依存の時刻表現                                    | `15:23:43`                       |
| `%Y-%m-%dT%H:%M:%S%z (%a)` | ISO 8601風のカスタム書式例             | `2025-03-29T15:23:43+0900 (Sat)` |
| *(その他 `os.date` の書式指定子)* |                                 |                                  |

**注意:** Windows環境では `os.date` の `%Z`, `%z` の挙動に制限があるため、`%TZ`, `%TZN`など、スクリプト内部でタイムゾーン処理を行うプレースホルダの使用が推奨されます。特に `%TZN` は `os.date` を使わずにタイムゾーン略称(%Z)とオフセット(%z)を含む書式を処理します。スクリプト内の `format_string_avoid_crash`, `osdate_avoid_crash` 変数は、クラッシュを避けるために特定の書式指定子を内部的に除去するために使われます。

## タイムゾーン処理詳細

* **TZ Database (zoneinfo/tzdata):** スクリプトは一般的なパス (Windows/Unix) を検索し、`zoneinfo` ディレクトリまたは `tzdata` ファイルを見つけようとします。見つかった場合、指定された`Time Zone`のTZIFバイナリファイルを解析し、正確なUTCオフセットと夏時間(DST)の遷移情報を使用します。`tzpath`設定でパスを手動指定することも可能です。
* **POSIX TZ 文字列:** TZ Databaseファイルが利用できない場合や、ファイルの有効期限を超える将来の日時については、TZIFファイル内に含まれるPOSIX TZ文字列（例: `PST8PDT,M3.2.0,M11.1.0`）に基づいてオフセットとDSTを計算しようと試みます。
* **Moment Timezone データ:** スクリプト内部に `America/Los_Angeles` の過去～未来約10年分のタイムゾーン遷移情報 (UTCオフセット、略称、遷移時刻) がMoment Timezoneのデータ形式に似た形でハードコードされており、TZ Databaseが見つからない場合のフォールバックや、特定のタイムゾーン処理に使用されることがあります。

## 注意事項

* **テキストソース:** 設定で指定したテキストソースが存在しない場合、更新は行われません。
* **タイムゾーンファイル:** 正確なタイムゾーン処理のためには、システムのどこかに `zoneinfo` または `tzdata` ファイルが存在することが望ましいです。PythonやCygwin、WSLなどをインストールしている場合、それらのパスから自動検出されることがあります。
* **パフォーマンス:** 1秒ごとのテキスト更新は、OBSのパフォーマンスにわずかな影響を与える可能性があります。
* **Windowsの `os.date` 制限:** Windowsの標準Lua実装では、`os.date`関数でのタイムゾーン名(`%Z`)や一部のオフセット形式(`%z`)、および1970年以前の時刻の扱いに制限があります。スクリプトはこの制限を回避・考慮するためにカスタムのタイムゾーン処理を行っています。